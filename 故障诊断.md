# 🔧 WebMind 故障诊断指南

## 📋 你遇到的问题总结

### ✅ 已修复：消息通道错误
```
❌ Error: A listener indicated an asynchronous response by returning true, 
   but the message channel closed before a response was received
```

**原因：**
- SidePanel 的消息监听器错误地返回了 `true`
- 表示要发送异步响应，但实际上没有调用 `sendResponse`

**修复：**
- 移除了不必要的 `return true`
- 添加了 `.catch()` 处理 sendMessage 错误

**现在需要：**
```bash
# 重新加载扩展
1. 打开 chrome://extensions/
2. 找到 WebMind
3. 点击 "重新加载" 🔄
4. 错误消失！
```

---

### ⚠️ 正常现象：AI Summarizer 不可用

```
[AI Mindmap] 📊 Summarizer 状态: unavailable
[AI Mindmap] ⚠️ Summarizer 不可用，使用降级方案
[AI Mindmap] 📋 使用降级方案（词频统计）
```

**这是正常的！**原因可能是：

#### 1. Chrome 版本问题
```bash
# 检查你的 Chrome 版本
chrome://version/

需要：Chrome 129+ (稳定版) 或 Chrome 127+ (需要手动配置)
```

#### 2. Gemini Nano 未启用

**快速启用步骤：**

##### 步骤 1: 启用 flags
```
1. 打开 chrome://flags/#optimization-guide-on-device-model
2. 设置为 "Enabled BypassPerfRequirement"
3. 打开 chrome://flags/#prompt-api-for-gemini-nano
4. 设置为 "Enabled"
5. 重启 Chrome
```

##### 步骤 2: 等待模型下载
```
打开控制台，执行：

(async () => {
  if ('ai' in self && 'summarizer' in (self as any).ai) {
    const status = await (self as any).ai.summarizer.availability();
    console.log('Summarizer 状态:', status);
    
    if (status === 'downloadable') {
      console.log('模型需要下载，开始下载...');
      const summarizer = await (self as any).ai.summarizer.create();
      console.log('模型下载中，请等待...');
    }
  } else {
    console.log('AI API 不可用');
  }
})();
```

##### 步骤 3: 检查下载进度
```
打开 chrome://on-device-internals/

查看 "Model Status" 标签页
确认 Gemini Nano 已下载
```

#### 3. 降级方案工作正常 ✅

**即使 AI 不可用，你的思维导图仍然能正常工作！**

```
✅ 降级方案（词频统计）已激活
✅ 生成了 50 个节点
✅ 创建了 101 条连线
✅ 思维导图正常显示
```

**降级 vs AI 对比：**

| 特性 | 降级方案 | AI 方案 |
|------|---------|---------|
| 节点内容 | 关键词 | 完整主题句 |
| 连接方式 | 词汇共现 | 语义相似度 |
| 速度 | 极快 (~50ms) | 较慢 (~2s) |
| 准确性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 可用性 | 100% | 取决于 Chrome |

---

## 🎯 完整测试流程

### 1. 重新加载扩展
```bash
chrome://extensions/ → 找到 WebMind → 重新加载
```

### 2. 清空控制台
```bash
F12 → Console → 点击 "Clear console" 🗑️
```

### 3. 添加测试笔记
```bash
打开任意网页 → 选中文字 → 点击 "添加到笔记"
```

### 4. 查看思维导图
```bash
打开侧边栏 → 切换到 "🧠 思维导图" 标签
```

### 5. 观察日志

#### ✅ 正常日志（无错误）
```
[AI Mindmap] 🚀 开始构建思维导图，笔记数量: 11
[AI Mindmap] 📊 Summarizer 状态: unavailable
[AI Mindmap] ⚠️ Summarizer 不可用，使用降级方案
[AI Mindmap] 📋 使用降级方案（词频统计）
[AI Mindmap] 📊 降级方案 - 节点: 50 连线: 101
```

**✅ 没有红色错误！**

#### 🚫 之前的错误日志（已修复）
```
❌ Uncaught (in promise) Error: A listener indicated an asynchronous response...
```

**❌ 这个错误不应该再出现了！**

---

## 🔍 如何启用 AI 功能

### 方法 1: 等待 Chrome 129 稳定版

**最简单的方法！**
```
1. 更新 Chrome 到 129+ 版本
2. AI 功能会自动可用
3. 无需任何配置
```

**当前状态检查：**
```bash
打开 chrome://version/
查看版本号
```

### 方法 2: 手动启用（Chrome 127+）

**适合尝鲜用户！**

#### 1️⃣ 启用实验性功能
```
chrome://flags/#optimization-guide-on-device-model
→ Enabled BypassPerfRequirement

chrome://flags/#prompt-api-for-gemini-nano
→ Enabled

重启 Chrome
```

#### 2️⃣ 触发模型下载
```javascript
// 在任意网页的控制台执行：
(async () => {
  const status = await ai.summarizer.availability();
  console.log('状态:', status);
  
  if (status === 'downloadable') {
    const summarizer = await ai.summarizer.create({
      output: { format: 'plain_text', language: 'en' }
    });
    console.log('下载已开始...');
  }
})();
```

#### 3️⃣ 等待下载完成
```
模型大小: ~1.7 GB
下载时间: 5-30 分钟

检查进度：chrome://on-device-internals/
```

#### 4️⃣ 验证可用性
```javascript
// 下载完成后，再次检查：
await ai.summarizer.availability();
// 应该返回 "available"
```

---

## 📊 日志含义解析

### 思维导图构建流程

#### 阶段 1: 初始化
```
[AI Mindmap] 🚀 开始构建思维导图，笔记数量: 11
```
✅ 检测到 11 条笔记

#### 阶段 2: 检查 AI
```
[AI Mindmap] 📊 Summarizer 状态: unavailable
```
⚠️ AI 不可用（正常，见上文）

#### 阶段 3: 自动降级
```
[AI Mindmap] ⚠️ Summarizer 不可用，使用降级方案
[AI Mindmap] 📋 使用降级方案（词频统计）
```
✅ 系统自动切换到传统算法

#### 阶段 4: 构建完成
```
[AI Mindmap] 📊 降级方案 - 节点: 50 连线: 101
```
✅ 成功生成思维导图！

---

## 🎯 预期结果

### 当前状态（降级方案）

**思维导图界面：**
```
💡 拖动节点可以调整布局，滚轮缩放查看细节
❌ AI 模型不可用，使用基础算法
```

**节点示例：**
```
- "learning"
- "intelligence"
- "data"
- "model"
- "network"
```

**特点：**
- ✅ 单个关键词
- ✅ 基于词频统计
- ✅ 连接基于共现关系

---

### 理想状态（AI 可用后）

**思维导图界面：**
```
💡 拖动节点可以调整布局，滚轮缩放查看细节
✅ Chrome 内置 AI 可用，将生成智能思维导图
```

**节点示例：**
```
- "AI simulates human intelligence"
- "Machine learning trains models with data"
- "Deep learning uses neural networks"
- "NLP processes natural language"
```

**特点：**
- ✅ 完整主题句
- ✅ AI 语义理解
- ✅ 连接基于相似度

---

## ❓ 常见问题

### Q1: 错误信息还会出现吗？
**答：不会！** 已经修复了消息通道错误。重新加载扩展后，错误应该消失。

### Q2: AI 什么时候可用？
**答：** 取决于你的 Chrome 版本和配置。参考上文的启用步骤。

### Q3: 降级方案够用吗？
**答：完全够用！** 降级方案仍然能生成有用的思维导图，只是节点是关键词而不是完整句子。

### Q4: 如何知道 AI 已启用？
**答：** 查看思维导图顶部的状态提示：
- ❌ "AI 模型不可用" → 降级方案
- ✅ "Chrome 内置 AI 可用" → AI 方案

### Q5: 能强制使用 AI 吗？
**答：不能。** 系统会自动检测 AI 可用性并选择最佳方案。

---

## 🔄 故障排查清单

```
问题诊断
[ ] 重新加载扩展
[ ] 清空控制台
[ ] 测试添加笔记
[ ] 查看思维导图
[ ] 检查是否有红色错误

AI 启用检查
[ ] Chrome 版本 >= 127
[ ] flags 已启用
[ ] Chrome 已重启
[ ] 模型已下载
[ ] availability 返回 "available"

功能验证
[ ] 笔记可以正常添加
[ ] 思维导图正常显示
[ ] 节点可以拖动
[ ] 缩放功能正常
[ ] 删除笔记正常
```

---

## 📞 需要帮助？

如果问题仍未解决，请提供：

1. **Chrome 版本**
   ```
   chrome://version/
   ```

2. **完整控制台日志**
   ```
   F12 → Console → 截图所有错误
   ```

3. **AI 可用性检查**
   ```javascript
   await ai.summarizer.availability();
   ```

4. **笔记数量**
   ```
   打开侧边栏 → 查看笔记总数
   ```

---

**最后更新：** 2025-10-23  
**问题状态：** ✅ 消息通道错误已修复  
**AI 状态：** ⚠️ 需要手动配置（可选）

